%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{ОБЗОР СУЩЕСТВУЮЩИХ ПОДХОДОВ РЕАЛИЗАЦИИ SIP-ТЕЛЕФОНИИ ДЛЯ WEB-БРАУЗЕРА}
\label{chapter:analysis}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Для разработки модуля телефонии для web-браузера необходимо сначала проанализировать существующие способы. Рассмотрим их в хронологическом порядке.

\section{Подход к реализации телефонии для web-браузера на Java}

Временем появления телефонии для браузера можно считать момент, когда в Java апплетах появилась поддерживать захвата аудио с микрофона. JRE широко распространена и обычно уже установлена в Windows и Linux системах.\cite{webrtc_flash_java} Java код выполняется на JRE установленной на компьютере или в расширении браузера, захватывает аудио с микрофона и отправляет его на сервер по протоколу RTP. Такой апплет должен быть подписан, и при его запуске пользователя спросят, желает ли он запустить подписанный апплет от данного производителя, который имеет доступ к функциям сетевого обмена, доступ к микрофону и т.п.

Преимущества данного подхода:
\begin{enumerate}
\item поддерживается большинством браузеров
\item возможность прямого взаимодействия с сервером по RTP
\item доступность JRE для конечного пользователя
\end{enumerate}

К сожалению, в Java есть проблемы с обработкой звука в реальном времени. А это почти всё алгоритмы, которые должны быть у каждого VoIP-телефона: AEC, AGC, AJB и Noise suppression (подавление шума).

Эхоподавление позволяет использовать динамики так, чтобы собеседник не слышал собственных слов, которые предаются обратно с динамиков на микрофон. AGC регулирует громкость так, чтобы не было слишком тихо или слишком громко. AJB устраняет большую задержку в передаче и "choppy audio" – прерывистый неразборчивый звук.

Все эти алгоритмы теоретически можно реализовать на Java, но это проблемно. Во-первых, реализовать универсальные и производительные алгоритмы (например, AEC) достаточно сложно. Во-вторых, реализация таких алгоритмов на Java может работать в несколько раз медленнее, чем на C/C++, а это может сказаться с большим расходом ресурсов клиентского CPU.

Производители Java апплетов с функцией звонков реализуют собственные обработчики звука или используют уже существующие решения на C/C++. Они используют в апплете библиотеки, которые берут на себя обработку вышеописанных алгоритмов. В результате Java апплет имеет стандартные VoIP функции для обеспечения качественного звонка со всеми VoIP алгоритмами.

Таким образом, подход к реализации VoIP-телефонии на Java имеет два недостатка:
\begin{enumerate}
\item сложность реализации алгоритмов обработки звука для каждой платформы
\item отсутствие кроссплатформенности - алгоритмы обработки звука должны быть реализованы на всех платформах, или используемые библиотеки должны быть кроссплатформенными
\item необходимо устанавливать JRE
\end{enumerate}

Довести DSP до отличного качества или купить соответствующие разработки может позволить себе не каждый вендор. То же касается поддержки различных кодеков для аудио и видео.

\section{Подход к реализации телефонии для web-браузера на Flash}

Начиная с 6 версии Flash Player умел взаимодействовать с FCS MX 1.0 и обмениваться с сервером потоками аудио данных.
Он умел захватывать аудио и кодировать его с помощью кодека NellyMoser, и видео и кодировать его с помощью кодека Sorenson Spark.
В качестве транспорта для аудио и видео в Flash Player 6 использовался протокол RTMP, который сегодня имеет открытую спецификацию, опубликованную Adobe. До полноценной VoIP-телефонии тогда было еще очень далеко. Но платформа делала свое дело и передавала звук и видео от одного плеера к другому через сервер.

Однако в связке Flash Player 6 + FCS MX 1.0 была задержка звука, она также осталась в следующих версиях сервера, включая последнюю Adobe Media Server. Причина в том, что RTMP протокол работает поверх TCP, а потому не приспособлен для полноценного VoIP. Для приложений реального времени лучше использовать UDP.

Проблему с UDP в Flash Player решили в 10 версии: ввели поддержку нового протокола RTMFP и функцию AEC. В 11 версии Flash Player добавили поддержку кодеков G.711 и H.264. В AS3 API так же имеются AJB для кодеков G.711 и Speex.

Итак, VoIP алгоритмы, которые поддерживает Flash Player 11: AEC, AJB, AES шифрование. Шифрование AES защищает трафик между браузером и сервером от посторонних.

Но у Flash Player есть небольшая проблема. В документации Adobe AS3 сказано, что RTMFP поддерживает три режима: надежная доставка, частично-надежная доставка, ненадежная доставка. Но есть только два флага для аудио и видео которые принимают либо "true" либо "false". "False" описывается как режим частичной доставки. В итоге, получается, что ненадежную доставку включить не удаётся, а при передачи звука она наиболее важна. Частичная доставка – это TCP ретрансмиты, которые происходят очень ограниченное время, но этого хватает, чтобы испортить звук в нестабильной сети. Такие ретрансмиты вызывают дрожание, которые портит поток. AJB на принимающей стороне не может справится с таким большим разбросом. Решением может оказаться добавление ненадёжной доставки на уровне протокола на серверной стороне.

Таким образом, у подхода к реализации VoIP-телефонии на Flash есть следующие преимущества:
\begin{enumerate}
\item поддерживается большинством браузеров
\item привычная технология для разработчиков – AS3
\item качественная передача аудио и видео
\end{enumerate}

Однако имеются и недостатки:
\begin{enumerate}
\item требует промежуточного сервера (не поддерживает открытые UDP протоколы, такие как RTP/SRTP)
\item отсутствие AGC
\item необходимо устанавливать Flash Player
\end{enumerate}

\section{Подход к реализации телефонии для web-браузера на WebRTC}

WebRTC - проект с открытым исходным кодом, предназначенный для организации передачи потоковых данных между браузерами или другими поддерживающими его приложениями по технологии точка-точка.\cite{WebRTC}

Технология WebRTC имеет продуманную архитектуру, избавленную от ошибок и недостатков, выявленных в плагинах браузера, которые существовали до неё. Технологические возможностях WebRTC: SRTP, DTLS, ICE, STUN, AEC, AGC, AJB, Opus, VP8.

//TODO nomenclature ICE STUN Opus VP8 SDK

Набор используемых в WebRTC технологий больше похож на VoIP SDK. SRTP и DTLS обеспечивает защиту трафика между WebRTC узлами. ICE и STUN помогают преодолеть NAT.\cite{sip_nat} AEC, AGC и AJB работают для того чтобы сделать аудио и видео качественным – без лагов и задержек. Кодеки Opus и VP8 хорошо подходят для глобального Интернета, где скорость соединения может неожиданно падать.

Однако надо отметить, что подходы к реализации VoIP-телефонии в браузере, рассмотренные ранее (Java и Flash) требуют дополнительной установки ПО. WebRTC – это единственная технология, которая является родной для браузера.

Преимущества технологии WebRTC:
\begin{enumerate}
\item все алгоритмы обработки звука
\item технология встроена в браузер
\item совместимость с традиционными VoIP
\item реализован на популярном среди web-разработчиков языке JavaScript
\end{enumerate}

Недостатки технологии WebRTC:
\begin{enumerate}
\item RFC ещё не разработан, на сегодняшний день существует черновик\cite{WebRTC_W3C}
\item Поддерживается не всеми браузерами
\item Необходима поддержка со стороны сервера (имеется поддержка известными Asterisk, FreeSWITCH)
\end{enumerate}

Как мы видим преимуществ у подхода для разработки модуля SIP-телефонии на основе технологии WebRTC больше. Недостатки же в ближайшее время будут устранятся.

//TODO
В браузере имеется возможность осуществлять обмен не по HTTP-протоколу, а с помощью WebSockets. Уже в 2009 году (http://blog.chromium.org/2009/12/web-sockets-now-available-in-google.html) они стали доступны
