%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{ОБЗОР СУЩЕСТВУЮЩИХ ПОДХОДОВ РЕАЛИЗАЦИИ SIP-ТЕЛЕФОНИИ ДЛЯ WEB-БРАУЗЕРА}
\label{chapter:analysis}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Реализация VoIP-телефонии в браузере довольно распространена. Первые модули VoIP-телефонии в браузере появились давно. Недостатком реализации таких модулей является замедление загрузки web-страницы. Это становится заметно когда пользователь занимается делами в web-приложении, не связанными со звонками.

Далее необходимо проанализировать существующие способы реализации VoIP-телефонии в web-браузере. Рассмотрим их в хронологическом порядке.

\section{Подход к реализации телефонии для web-браузера на Java}

Временем появления телефонии для браузера можно считать момент, когда в Java апплетах появилась поддерживать захвата аудио с микрофона. Среда выполнения для Java (Java Runtime Environment, JRE) широко распространена и обычно уже установлена в Windows и Linux системах.\cite{webrtc_flash_java} Java код выполняется на JRE установленной на компьютере или в расширении браузера, захватывает аудио с микрофона и отправляет его на сервер по протоколу передачи данных в реальном времени (Real-time Transport Protocol, RTP). Такой апплет должен быть подписан, и при его запуске пользователя спросят, желает ли он запустить подписанный апплет от данного производителя, который имеет доступ к функциям сетевого обмена, доступ к микрофону и т.п.

Преимущества данного подхода:
\begin{enumerate}
\item Поддерживается большинством браузеров
\item Возможность прямого взаимодействия с сервером по RTP
\item Доступность JRE для конечного пользователя
\end{enumerate}

К сожалению, в Java есть проблемы с обработкой звука в реальном времени. А это почти всё алгоритмы, которые должны быть у каждого VoIP-телефона: эхоподавление (Acoustic Echo Cancellation, AEC), автоматическая регулировка усиления (Automatic Gain Control, AGC), буфер выравнивания задержек передачи (Adaptive Jitter Buffer, AJB) и подавление шума (Noise suppression).

AEC позволяет использовать динамики так, чтобы собеседник не слышал собственных слов, которые предаются обратно с динамиков на микрофон. AGC регулирует громкость так, чтобы не было слишком тихо или слишком громко. AJB устраняет большую задержку в передаче и "choppy audio" – прерывистый неразборчивый звук.

Все эти алгоритмы теоретически можно реализовать на Java, но это проблемно. Во-первых, реализовать универсальные и производительные алгоритмы (например, AEC) достаточно сложно. Во-вторых, реализация таких алгоритмов на Java может работать в несколько раз медленнее, чем на C/C++, а это может сказаться с большим расходом ресурсов процессора клиента.

Производители Java апплетов с функцией звонков реализуют собственные обработчики звука или используют уже существующие решения на C/C++. Они используют в апплете библиотеки, которые берут на себя обработку вышеописанных алгоритмов. В результате Java апплет имеет стандартные VoIP функции для обеспечения качественного звонка со всеми VoIP алгоритмами.

Недостатки подхода реализации VoIP-телефонии на Java:
\begin{enumerate}
\item Сложность реализации алгоритмов обработки звука для каждой платформы
\item Отсутствие кроссплатформенности - алгоритмы обработки звука должны быть реализованы на всех платформах, или используемые библиотеки должны быть кроссплатформенными
\item Необходимо устанавливать JRE
\end{enumerate}

Довести алгоритмы обработки до отличного качества или купить соответствующие разработки может позволить себе не каждый вендор. То же касается поддержки различных кодеков для аудио и видео.

\section{Подход к реализации телефонии для web-браузера на Flash}

Для обмена данными в этом подходе необходим Adobe Flash Player и Adobe Media Server. Для передачи голоса используется протокол RTMFP, работающий по UDP. Имеется поддержку распространённых кодеков G.711 и H.264.

Flash Player 11 (последняя версия на сегодня) поддерживают VoIP алгоритмы: AEC, AJB, симметричный алгоритм блочного шифрования AES. Шифрование AES защищает трафик между браузером и сервером от посторонних. Передачу данных осуществляется по протоколу RTMFP, работающего по UDP.\cite{adobe}

У подхода к реализации VoIP-телефонии на Flash есть следующие преимущества:
\begin{enumerate}
\item Поддерживается большинством браузеров
\item Привычная технология для разработчиков – Action Script 3
\item Качественная передача аудио и видео
\end{enumerate}

Недостатки данного подхода:
\begin{enumerate}
\item Требует промежуточного сервера (не поддерживает открытые UDP протоколы, такие как RTP/SRTP)
\item Отсутствие AGC
\item Необходимо устанавливать Flash Player
\end{enumerate}

\section{Подход к реализации телефонии для web-браузера на WebRTC}

У современных браузеров имеется множество возможностей, предоставляющих огромное количество инструментов для разработки. Прежде чем переходить к технологии Web-коммуникаций в реальном времени (Web Real-Time Communications, WebRTC) необходимо рассмотреть какие есть инструменты разработки у браузера для сетевой передачи данных.

\subsection{Краткая историческая справка о возможностях браузера передавать информацию}

Около 15 лет назад клиент просматривал web-страницы, только переходя с одной на другую. Примерно в 2005 году, появился способ сделать страницы динамичными с помощью AJAX. С тех пор, почти весь обмен по HTTP инициировался клиентом разными способами, например каким-нибудь действием, или периодическим опросом сервера на получение новых данных. Однако при таком обмене появляется задержка каждый раз при получении новых данных от сервера. Эта задержка возникает из-за необходимости установления HTTP-соединения. Это создавало проблемы для создания web-приложений реального времени.\cite{ajax_problem}

Около 5 лет назад появилась новая технология, которая позволила обмениваться двум сторонам асинхронно и симметрично. Это полнодуплексный протокол WebSocket, который работает поверх TCP. Уже в 2009 году вышла первая версия браузера, поддерживающая стандарт.\cite{web_socket_begining} В 2012 году браузер Bowser начал первым в мире, поддерживать технологию WebRTC, которая использует WebSocket и позволяет совершать аудио и видео звонки прямо из браузера.\cite{bowser}

\subsection{Обзор технологии WebRTC}
\label{subsection:reviewWebRTC}

WebRTC - проект с открытым исходным кодом, предназначенный для организации передачи потоковых данных между браузерами или другими поддерживающими его приложениями по технологии точка-точка.\cite{WebRTC}

Технология WebRTC имеет продуманную архитектуру, избавленную от ошибок и недостатков, выявленных в плагинах браузера, которые существовали до неё. Технологические возможности WebRTC: безопасный протоколу передачи данных в реальном времени (Secure Real-time Transport Protocol, SRTP), протокол датаграмм безопасности транспортного уровня (Datagram Transport Layer Security, DTLS), установление интерактивного соединения (Interactive Connectivity Establishment, ICE), утилиты прохождения сессий для NAT (Session Traversal Utilities for NAT, STUN), AEC, AGC, AJB, аудиокодек Opus, видеокодек VP8.

Набор используемых в WebRTC технологий очень большой. SRTP и DTLS обеспечивают защиту трафика между WebRTC узлами. ICE и STUN помогают преодолеть NAT.\cite{sip_nat} AEC, AGC и AJB работают для того чтобы сделать аудио и видео качественным – без лагов и задержек. Кодеки Opus и VP8 хорошо подходят для глобального Интернета, где скорость соединения может резко изменяться.

Также нужно отметить, что подходы к реализации VoIP-телефонии в браузере, рассмотренные ранее (Java и Flash) требуют дополнительной установки ПО. WebRTC – это единственная технология, которая является встроенной в браузер. То есть в самом браузере имеются компоненты WebRTC. С помощью JavaScript к этим компонентам можно обращаться прямо со страницы. Сегодня уже достаточно большое количество web-браузеров поддерживают WebRTC, подробная информация приведена в таблице \ref{table:browsers}.\cite{browsers_url}

\begin{table}
    \caption{Поддержка WebRTC web-браузерами}
    \begin{center}
    \begin{tabular}{|l|l|}
    \hline
    \textbf{Web-браузер} & \textbf{Версия}\\
    \hline
    IE & 11 \\
    \hline
    Edge & 13 \\
    \hline
    Firefox & 45 \\
    \hline
    Chrome & 29 \\
    \hline
    Safari & 9.1 \\
    \hline
    Opera & 38 \\
    \hline
    iOS Safari & 8.4 \\
    \hline
    Opera Mini & - \\
    \hline
    Android Browser & 4.4 \\
    \hline
    Chrome for Android & 50 \\
    \hline
    \end{tabular}
    \end{center}
    \label{table:browsers}
\end{table}

Преимущества технологии WebRTC:
\begin{enumerate}
\item Все алгоритмы обработки звука VoIP телефонии
\item Технология встроена в браузер
\item Совместимость с традиционными VoIP
\item Реализован на популярном среди web-разработчиков языке JavaScript
\item Поддерживается многими серверами IP-телефонии (Asterisk, FreeSWITCH, Kamailio, OverSIP, OfficeSIP и др.)
\end{enumerate}

Недостатки технологии WebRTC:
\begin{enumerate}
\item RFC ещё не разработан, на сегодняшний день существует черновик\cite{WebRTC_W3C}
\item Поддерживается не всеми браузерами
\end{enumerate}

Как мы видим преимуществ у подхода для разработки модуля IP-телефонии на основе технологии WebRTC больше. Недостатки же в ближайшее время будут устранятся.

\section{Обзор существующих реализаций IP-телефонии в web-браузере}
\label{section:review}

Рассмотрим существующие на сегодняшний день реализации IP-телефонии в web-браузере. В частности рассмотрим самые рейтинговые CRM-системы Битрикс24 и amoCRM.\cite{bestCRMs} А также рассмотрим одну из наиболее распространённых CRM-систем с открытым исходным кодом vtiger CRM.

\subsection{IP-телефония в amoCRM}

В amoCRM имеется виджет UIS, который предоставляет доступ к облачному серверу IP-телефонии АТС UIS. Виджет работает по технологии WebRTC, и в связке с сервером АТС UIS реализованы следующие возможности\cite{amoCRM}:
\begin{itemize}
\item запись звонков
\item коллтрекинг
\item сценарии обработки вызовов
\item голосовое меню и почта
\item виртуальный факс
\end{itemize}

Так же имеется виджет OnlinePBX, который использует виртуальную АТС OnlinePBX. Помимо этих двух виджетов имеется бесплатный виджет Asterisk. Все эти виджеты по функциональности почти не отличаются.

\subsection{IP-телефония в Битрикс24}

Телефония в Битрикс24 реализована с помощью технологии WebRTC. Телефонию эту можно использовать бесплатно, однако при бесплатном использовании имеется ограничение на число возможных абонентов а также нет возможности записи разговора. Коллтрекинг отсутствует, но зато имеется возможность видео звонков. Функция IP-телефонии работает только в браузерах Google Chrome и Firefox.\cite{bitrix24}

\subsection{IP-телефония в vtiger CRM}

Телефония в vtiger CRM реализована следующим образом. Все контакты доступны на сайте, но, чтобы позвонить необходимо иметь сторонний софт-фон или же аппаратный телефон. Взаимодействие такого стороннего телефона с CRM-системой выполняет модуль Connector. Он принимает с сервера VoIP-телефонии информацию о звонке и отправляет её в CRM-систему, в которой уже создаётся карточка звонка.

\section{Резюме}

В данном разделе был проведён анализ существующих подходов для реализации VoIP-телефонии в браузере. На сегодняшний день лучшим является подход, использующий в качестве инструмента технологию WebRTC. В нём реализованы необходимые для VoIP-телефонии алгоритмы, а также не требуется установка дополнительного программного обеспечения.

Были рассмотренны и существующие реализации VoIP-телефонии в современных CRM-системах. Видно, что телефония из браузера имеется ещё не во всех CRM-системах. В тех, в которых имеется, она часто платная и работает не во всех браузерах. Также отсутствуют решения, которые бы работали для любой бизнес-системы или CRM-системы.
